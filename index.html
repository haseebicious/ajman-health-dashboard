<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ajman Health & Food Safety Dashboard</title>
  <link rel="icon" href="assets/ajman-data-logo.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f7fa; color: #2c3e50; margin: 0; }
    .header { display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%); color: white; padding: 1.5rem 2rem; }
    .header .logos { display: flex; gap: 1.5rem; align-items: center; }
    .header img { height: 56px; background: white; border-radius: 8px; padding: 3px; }
    .header h1 { font-size: 2rem; margin: 0 0 0 1rem; }
    .controls-container { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background-color: #eef2f7; border-bottom: 1px solid #d1d9e6; }
    .filter-group label { font-weight: 600; margin-right: 0.5rem; color: #1e3a5f; }
    .filter-group select { padding: 0.5rem; border-radius: 6px; border: 1px solid #d1d9e6; font-size: 1rem; }
    .lang-toggle button { background: #fff; color: #1e3a5f; border: none; font-weight: bold; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; margin-left: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .lang-toggle button.active { background: #7c3aed; color: #fff; }
    .metrics-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; padding: 2rem; max-width: 1400px; margin: 0 auto; }
    .metric-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; }
    .metric-title { color: #7c3aed; font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }
    .metric-value { font-size: 2.1rem; font-weight: 700; color: #1e3a5f; }
    .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 2rem; padding: 0 2rem 2rem; max-width: 1400px; margin: 0 auto; }
    .chart-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column; }
    .chart-card h3 { font-size: 1.15rem; margin-top: 0; margin-bottom: 1rem; color: #1e3a5f; }
    .chart-container { position: relative; height: 320px; flex-grow: 1; }
    .chart-narrative { font-size: 0.95rem; margin-top: 1rem; color: #444; }
    .chart-source { font-size: 0.8rem; color: #777; margin-top: 0.75rem; text-align: right; }
    .chart-source a { color: #555; text-decoration: underline; }
    .insights-section { background: white; margin: 2rem; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 1360px; margin: 2rem auto; }
    .insights-section h2 { color: #1e3a5f; margin-bottom: 1.5rem; font-size: 1.3rem; }
    .insight-item { display: flex; align-items: flex-start; margin-bottom: 1.2rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid #7c3aed; }
    .insight-icon { font-size: 1.5rem; margin-right: 1rem; }
    .insight-text h4 { color: #1e3a5f; margin-bottom: 0.5rem; }
    .footer { background: #1e3a5f; color: white; padding: 2rem; text-align: center; margin-top: 2rem; }
    .footer p { margin: 0.5rem 0; opacity: 0.9; }
    .footer a { color: #93c5fd; }
    .footer a:hover { text-decoration: underline; }
    .footer .credits { margin-top: 1.5rem; border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 1.5rem; }
    .footer .credits p { margin: 0.4rem 0; font-size: 0.95rem; }
    .footer .credits strong { color: #fff; }

    /* Custom Tooltip */
    #chartjs-tooltip {
      opacity: 0;
      position: absolute;
      background: white;
      color: #2c3e50;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: opacity .2s ease, transform .2s ease;
      pointer-events: none;
      padding: 0.75rem;
      font-family: 'Segoe UI', Arial, sans-serif;
      border: 1px solid #e2e8f0;
      z-index: 100;
    }
    #chartjs-tooltip table {
      margin: 0;
      border-collapse: collapse;
    }
    #chartjs-tooltip th {
      font-weight: 700;
      padding-bottom: 0.5rem;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid #e2e8f0;
      text-align: left;
    }
    html[dir="rtl"] #chartjs-tooltip th {
      text-align: right;
    }
    #chartjs-tooltip td {
      padding: 0.4rem 0;
      font-size: 0.9rem;
    }
    .tooltip-body-item {
      display: flex;
      align-items: center;
      white-space: nowrap;
    }
    .tooltip-color-box {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      margin-right: 0.6rem;
      flex-shrink: 0;
    }
    html[dir="rtl"] .tooltip-color-box {
      margin-right: 0;
      margin-left: 0.6rem;
    }

    @media (max-width: 992px) {
        .charts-container { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .header { flex-direction: column; align-items: flex-start; text-align: center; }
      .header .logos { justify-content: center; width: 100%; }
      .header h1 { font-size: 1.5rem; }
      .controls-container { flex-direction: column; gap: 1rem; }
      .metrics-container { grid-template-columns: 1fr; }
      .header img { height: 40px; }
    }
  </style>
</head>
<body>
  <div class="header" id="header">
    <div class="logos">
      <a href="https://data.ajman.ae/pages/homepage/" target="_blank" rel="noopener noreferrer">
        <img src="assets/ajman-data-logo.png" alt="Ajman Data Logo" />
      </a>
      <a href="https://drive.google.com/file/d/117tCPxZFDSuK42dQhU_oRK0INWZ8Su2k/view" target="_blank" rel="noopener noreferrer">
        <img src="assets/ajman-vision-2030-logo.png" alt="Ajman Vision 2030 Logo" />
      </a>
      <h1 id="dashboardTitle"></h1>
    </div>
  </div>
    
  <div class="controls-container">
    <div class="filter-group">
      <label for="yearFilter" id="yearFilterLabel">Filter by Year:</label>
      <select id="yearFilter">
        <option value="all">All Years</option>
      </select>
    </div>
    <div class="lang-toggle" id="langToggle">
      <button id="enBtn" class="active" onclick="setLang('en')">English</button>
      <button id="arBtn" onclick="setLang('ar')">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
    </div>
  </div>

  <p id="dashboardSubtitle" style="text-align:center; margin:1rem 0 0.5rem;"></p>
  <div class="metrics-container" id="metricsContainer"></div>
  <div class="charts-container" id="chartsContainer"></div>
  <div class="insights-section" id="insightsSection">
    <h2 id="insightsTitle"></h2>
    <div id="insightsList"></div>
  </div>
  <div class="footer">
    <p id="footerSource"></p>
    <p id="footerVision"></p>
    <p>
      Primary Data Source: 
      <a href="https://data.ajman.ae/explore/?refine.theme=Health+well-being+and+care" target="_blank">Ajman Data Portal | Ø¨ÙˆØ§Ø¨Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¬Ù…Ø§Ù†</a>
    </p>
    <div class="credits">
      <p><strong>Developed by:</strong> Haseebullah Jumakhan (<a href="mailto:202320029@ajmanuni.ac.ae">202320029@ajmanuni.ac.ae</a>)</p>
      <p><strong>Supervised by:</strong> Prof. Mohamed Deriche (<a href="mailto:m.deriche@ajman.ac.ae">m.deriche@ajman.ac.ae</a>)</p>
      <p>Â© 2025 - Ajman University</p>
    </div>
  </div>
  <script>
    const translations = {
      en: {
        dashboardTitle: "Ajman Health & Food Safety Dashboard",
        dashboardSubtitle: "Empowering Ajmanâ€™s Future: Data-Driven Health for All",
        yearFilterLabel: "Filter by Year:",
        allYears: "All Years",
        metrics: [
          { title: "Shops Inspected" }, { title: "Food Safety Pass Rate" },
          { title: "Violations Issued" }, { title: "Products Confiscated (kg)" },
          { title: "Export Certificates" }
        ],
        charts: [
          "Medical Certificates Issued (Export & Veterinary)", "Food Laboratory Test Results (Fit vs Unfit)",
          "Confiscated Food & Health Products (kg)", "Warnings & Violations by Category", "Shops Visited for Inspection"
        ],
        chartNarratives: [
          "Export and veterinary health certification activity. When viewing 'All Years', export certifications dominate, reflecting strong oversight. For a single year, see monthly trends.",
          "Food safety testing results. The long-term trend shows a steady improvement in 'Fit' samples. Filtering by year reveals seasonal patterns in food safety.",
          "Confiscated product volumes indicate active enforcement. Spikes often follow increased inspections or targeted campaigns during specific months or years.",
          "Most violations are issued to companies. Filtering by year can highlight the impact of targeted education or enforcement campaigns on violation types.",
          "Inspection activity shows Ajmanâ€™s preventive approach to health and food safety, with peaks often visible during high-risk periods or specific campaigns."
        ],
        insightsTitle: "Key Insights & Vision 2030 Alignment",
        insights: [
          { icon: "ðŸŒ±", title: "Sustainability in Action", text: "Reduction in unsafe food and increased preventive enforcement support Ajmanâ€™s sustainability goals." },
          { icon: "ðŸ¤", title: "Community Well-being", text: "Transparent health data empowers citizens and supports inclusive, healthy communities." },
          { icon: "ðŸ’¡", title: "Innovation for Impact", text: "Real-time, interactive analytics enable evidence-based policy and government excellence." },
          { icon: "ðŸ“ˆ", title: "Human Capital Development", text: "Open data and insights foster education, research, and a future-ready society." }
        ],
        footerSource: 'Data sources for each visualization are listed on the chart card. All data is provided by the Ajman Data Portal.',
        footerVision: "Aligned with Ajman Vision 2030 for a sustainable, healthy, and inclusive future."
      },
      ar: {
        dashboardTitle: "Ù„ÙˆØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØ­Ø© ÙˆØ³Ù„Ø§Ù…Ø© Ø§Ù„ØºØ°Ø§Ø¡ Ø¹Ø¬Ù…Ø§Ù†",
        dashboardSubtitle: "ØªÙ…ÙƒÙŠÙ† Ù…Ø³ØªÙ‚Ø¨Ù„ Ø¹Ø¬Ù…Ø§Ù†: Ø§Ù„ØµØ­Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
        yearFilterLabel: "ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø³Ù†Ø©:",
        allYears: "ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª",
        metrics: [
          { title: "Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… ØªÙØªÙŠØ´Ù‡Ø§" }, { title: "Ù…Ø¹Ø¯Ù„ Ù†Ø¬Ø§Ø­ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø£ØºØ°ÙŠØ©" },
          { title: "Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„ØµØ§Ø¯Ø±Ø©" }, { title: "Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØµØ§Ø¯Ø±Ø© (ÙƒØ¬Ù…)" }, { title: "Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ±" }
        ],
        charts: [
          "Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„ØµØ­ÙŠØ© Ø§Ù„ØµØ§Ø¯Ø±Ø© (ØªØµØ¯ÙŠØ± ÙˆØ¨ÙŠØ·Ø±ÙŠØ©)", "Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø®ØªØ¨Ø± Ø§Ù„Ø£ØºØ°ÙŠØ© (ØµØ§Ù„Ø­Ø©/ØºÙŠØ± ØµØ§Ù„Ø­Ø©)",
          "Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØµØ­ÙŠØ© Ø§Ù„Ù…ØµØ§Ø¯Ø±Ø© (ÙƒØ¬Ù…)", "Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©", "Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªÙ…Øª Ø²ÙŠØ§Ø±ØªÙ‡Ø§ Ù„Ù„ØªÙØªÙŠØ´"
        ],
        chartNarratives: [
          "Ù†Ø´Ø§Ø· Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„ØµØ­ÙŠØ© Ù„Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø¨ÙŠØ·Ø±ÙŠØ©. Ø¹Ù†Ø¯ Ø¹Ø±Ø¶ 'ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª'ØŒ ØªØªØµØ¯Ø± Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø´Ù‡Ø¯ØŒ Ù…Ù…Ø§ ÙŠØ¹ÙƒØ³ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ù‚ÙˆÙŠØ©. Ù„Ø³Ù†Ø© ÙˆØ§Ø­Ø¯Ø©ØŒ Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©.",
          "Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø£ØºØ°ÙŠØ©: ÙŠÙØ¸Ù‡Ø± Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø·ÙˆÙŠÙ„ Ø§Ù„Ø£Ù…Ø¯ ØªØ­Ø³Ù†Ù‹Ø§ Ù…Ø³ØªÙ…Ø±Ù‹Ø§ ÙÙŠ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª 'Ø§Ù„ØµØ§Ù„Ø­Ø©'. Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø³Ù†Ø© ØªÙƒØ´Ù Ø¹Ù† Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…ÙˆØ³Ù…ÙŠØ© ÙÙŠ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø£ØºØ°ÙŠØ©.",
          "ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØµØ§Ø¯Ø±Ø© ØªØ¹ÙƒØ³ ÙØ¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¥Ù†ÙØ§Ø°. ØºØ§Ù„Ø¨Ù‹Ø§ Ù…Ø§ ØªØªØ¨Ø¹ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹Ø§Øª Ø²ÙŠØ§Ø¯Ø© ÙÙŠ Ø§Ù„ØªÙØªÙŠØ´ Ø£Ùˆ Ø­Ù…Ù„Ø§Øª Ù…ÙˆØ¬Ù‡Ø© Ø®Ù„Ø§Ù„ Ø£Ø´Ù‡Ø± Ø£Ùˆ Ø³Ù†ÙˆØ§Øª Ù…Ø¹ÙŠÙ†Ø©.",
          "ØªØµØ¯Ø± Ù…Ø¹Ø¸Ù… Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ù„Ù„Ø´Ø±ÙƒØ§Øª. ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙØ¨Ø±Ø² Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø³Ù†Ø© ØªØ£Ø«ÙŠØ± Ø­Ù…Ù„Ø§Øª Ø§Ù„ØªÙˆØ¹ÙŠØ© Ø£Ùˆ Ø§Ù„Ø¥Ù†ÙØ§Ø° Ø§Ù„Ù…ÙˆØ¬Ù‡Ø© Ø¹Ù„Ù‰ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø®Ø®Ø§Ù„ÙØ§Øª.",
          "ÙŠÙØ¸Ù‡Ø± Ù†Ø´Ø§Ø· Ø§Ù„ØªÙØªÙŠØ´ Ù†Ù‡Ø¬ Ø¹Ø¬Ù…Ø§Ù† Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠ Ù„Ù„ØµØ­Ø© ÙˆØ³Ù„Ø§Ù…Ø© Ø§Ù„ØºØ°Ø§Ø¡ØŒ Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ø°Ø±ÙˆØ§Øª ØºØ§Ù„Ø¨Ù‹Ø§ Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø§Øª Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø®Ø·ÙˆØ±Ø© Ø£Ùˆ Ø­Ù…Ù„Ø§Øª Ù…Ø¹ÙŠÙ†Ø©."
        ],
        insightsTitle: "Ø±Ø¤Ù‰ Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆÙ…Ø­Ø§Ø°Ø§Ø© Ù…Ø¹ Ø±Ø¤ÙŠØ© Ø¹Ø¬Ù…Ø§Ù† 2030",
        insights: [
          { icon: "ðŸŒ±", title: "Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°", text: "Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ø£ØºØ°ÙŠØ© ØºÙŠØ± Ø§Ù„ØµØ§Ù„Ø­Ø© ÙˆØ²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¥Ù†ÙØ§Ø° Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠ ÙŠØ¯Ø¹Ù… Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø© ÙÙŠ Ø¹Ø¬Ù…Ø§Ù†." },
          { icon: "ðŸ¤", title: "Ø±ÙØ§Ù‡ÙŠØ© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹", text: "Ø§Ù„Ø´ÙØ§ÙÙŠØ© ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØ­Ø© ØªÙ…ÙƒÙ‘Ù† Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ† ÙˆØªØ¯Ø¹Ù… Ù…Ø¬ØªÙ…Ø¹Ø§Øª ØµØ­ÙŠØ© Ø´Ø§Ù…Ù„Ø©." },
          { icon: "ðŸ’¡", title: "Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø± Ù…Ù† Ø£Ø¬Ù„ Ø§Ù„ØªØ£Ø«ÙŠØ±", text: "Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ ØªÙ…ÙƒÙ† Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ù„Ø© ÙˆØ§Ù„ØªÙ…ÙŠØ² Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠ." },
          { icon: "ðŸ“ˆ", title: "ØªØ·ÙˆÙŠØ± Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø¨Ø´Ø±ÙŠ", text: "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙˆØ§Ù„Ø±Ø¤Ù‰ ØªØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ø¨Ø­Ø« ÙˆÙ…Ø¬ØªÙ…Ø¹ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„." }
        ],
        footerSource: 'Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙƒÙ„ ØªØµÙˆØ± Ù…Ø¯Ø±Ø¬Ø© ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† Ø¨ÙˆØ§Ø¨Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¬Ù…Ø§Ù†.',
        footerVision: "ØªÙ…Ø§Ø´ÙŠØ§Ù‹ Ù…Ø¹ Ø±Ø¤ÙŠØ© Ø¹Ø¬Ù…Ø§Ù† 2030 Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ù…Ø³ØªØ¯Ø§Ù… ÙˆØµØ­ÙŠ ÙˆØ´Ø§Ù…Ù„."
      }
    };

    let currentLang = 'en';
    let dataStore = {};
    let chartInstances = [];

    const files = {
        certificates: {
            path: 'data/medical-certificates-issued.json',
            sourceUrl: 'https://data.ajman.ae/explore/dataset/health-certificates-for-food-export/information/'
        },
        foodLab: {
            path: 'data/food-laboratory-test-results.json',
            sourceUrl: 'https://data.ajman.ae/explore/dataset/food-laboratory-test-results/information/'
        },
        confiscated: {
            path: 'data/confiscated-food-and-health-products.json',
            sourceUrl: 'https://data.ajman.ae/explore/dataset/confiscated-food-and-health-products/information/'
        },
        violations: {
            path: 'data/warnings-and-public-health-violations.json',
            sourceUrl: 'https://data.ajman.ae/explore/dataset/warnings-and-public-health-violations/information/'
        },
        shops: {
            path: 'data/shops-visited.json',
            sourceUrl: 'https://data.ajman.ae/explore/dataset/shops-visited/information/'
        }
    };
    
    // --- DATA FETCHING AND INITIALIZATION ---
    Promise.all(Object.entries(files).map(([key, value]) =>
      fetch(value.path).then(r => r.json()).then(data => [key, data])
    )).then(results => {
      results.forEach(([key, data]) => dataStore[key] = data);
      initializeDashboard();
    });

    function initializeDashboard() {
        populateYearFilter();
        document.getElementById('yearFilter').addEventListener('change', updateDashboard);
        setLang(currentLang); // This will trigger the first render
    }
    
    function updateDashboard() {
        const selectedYear = document.getElementById('yearFilter').value;
        renderMetrics(selectedYear);
        renderCharts(selectedYear);
    }

    function setLang(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;
      document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
      
      document.getElementById('enBtn').classList.toggle('active', lang === 'en');
      document.getElementById('arBtn').classList.toggle('active', lang === 'ar');
      
      const trans = translations[lang];
      document.getElementById('dashboardTitle').textContent = trans.dashboardTitle;
      document.getElementById('dashboardSubtitle').textContent = trans.dashboardSubtitle;
      document.getElementById('yearFilterLabel').textContent = trans.yearFilterLabel;
      document.querySelector('#yearFilter option[value="all"]').textContent = trans.allYears;
      document.getElementById('insightsTitle').textContent = trans.insightsTitle;
      document.getElementById('footerSource').innerHTML = trans.footerSource;
      document.getElementById('footerVision').textContent = trans.footerVision;
      
      renderInsights();
      updateDashboard(); // Re-render metrics and charts with new language
    }

    function populateYearFilter() {
        const yearSet = new Set();
        Object.values(dataStore).flat().forEach(row => {
            if (row.year) yearSet.add(String(parseInt(row.year)));
        });
        const yearFilter = document.getElementById('yearFilter');
        const sortedYears = Array.from(yearSet).sort((a, b) => b - a);
        sortedYears.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearFilter.appendChild(option);
        });
    }

    function filterDataByYear(data, selectedYear) {
        if (selectedYear === 'all' || !data) return data;
        return data.filter(row => String(parseInt(row.year)) === selectedYear);
    }

    // --- RENDER FUNCTIONS ---
    function renderMetrics(selectedYear) {
        const metrics = [];
        const transMetrics = translations[currentLang].metrics;

        const shops = filterDataByYear(dataStore.shops, selectedYear);
        const foodLab = filterDataByYear(dataStore.foodLab, selectedYear);
        const violations = filterDataByYear(dataStore.violations, selectedYear);
        const conf = filterDataByYear(dataStore.confiscated, selectedYear);
        const cert = filterDataByYear(dataStore.certificates, selectedYear);

        metrics.push({ title: transMetrics[0].title, value: (shops.reduce((sum, row) => sum + (parseFloat(row.number_of_shops_visited) || 0), 0)).toLocaleString() });
        
        const fit = foodLab.filter(r => r.analysis_results_en === "Fit" || r.analysis_results_ar === "ØµØ§Ù„Ø­Ø©").reduce((s, r) => s + (parseFloat(r.value) || 0), 0);
        const unfit = foodLab.filter(r => r.analysis_results_en === "Unfit" || r.analysis_results_ar === "ØºÙŠØ± ØµØ§Ù„Ø­Ø©").reduce((s, r) => s + (parseFloat(r.value) || 0), 0);
        const passRate = (fit + unfit) > 0 ? (fit / (fit + unfit) * 100).toFixed(1) + "%" : "N/A";
        metrics.push({ title: transMetrics[1].title, value: passRate });

        metrics.push({ title: transMetrics[2].title, value: (violations.reduce((s, r) => s + (parseFloat(r.number_of_violations_and_cleanliness_issued_by_waste_management_public_higiene_sec) || 0), 0)).toLocaleString() });
        metrics.push({ title: transMetrics[3].title, value: (conf.reduce((s, r) => s + (parseFloat(r.confiscated_food_and_health_products_kg) || 0), 0)).toLocaleString() });
        
        const totalExport = cert.filter(r => r.category_en === "Export CoH issued" || r.category_ar === "Ø´Ù‡Ø§Ø¯Ø§Øª ØµØ­ÙŠØ© ØªØµØ¯ÙŠØ±").reduce((s, r) => s + (parseFloat(r.number_of_certificates_of_health) || 0), 0);
        metrics.push({ title: transMetrics[4].title, value: totalExport.toLocaleString() });

        document.getElementById('metricsContainer').innerHTML = metrics.map(m =>
            `<div class="metric-card"><div class="metric-title">${m.title}</div><div class="metric-value">${m.value}</div></div>`
        ).join('');
    }

    function renderCharts(selectedYear) {
        chartInstances.forEach(ch => ch.destroy());
        chartInstances = [];
        const chartsDiv = document.getElementById('chartsContainer');
        const transCharts = translations[currentLang].charts;
        const transNarratives = translations[currentLang].chartNarratives;

        const chartConfigs = [
            { id: 'certificatesChart', title: transCharts[0], narrative: transNarratives[0], source: files.certificates },
            { id: 'foodLabChart', title: transCharts[1], narrative: transNarratives[1], source: files.foodLab },
            { id: 'confiscatedChart', title: transCharts[2], narrative: transNarratives[2], source: files.confiscated },
            { id: 'violationsChart', title: transCharts[3], narrative: transNarratives[3], source: files.violations },
            { id: 'shopsChart', title: transCharts[4], narrative: transNarratives[4], source: files.shops },
        ];

        chartsDiv.innerHTML = chartConfigs.map(c => `
            <div class="chart-card">
                <h3>${c.title}</h3>
                <div class="chart-container"><canvas id="${c.id}"></canvas></div>
                <div class="chart-narrative">${c.narrative}</div>
                <div class="chart-source">
                  Source: <a href="${c.source.sourceUrl}" target="_blank" rel="noopener noreferrer">${c.source.path.split('/')[1]}</a>
                </div>
            </div>
        `).join('');

        if (selectedYear === 'all') {
            renderAllYearsCharts();
        } else {
            renderSingleYearCharts(selectedYear);
        }
    }

    function renderAllYearsCharts() {
        const certYears = [...new Set(dataStore.certificates.map(r => String(parseInt(r.year))))].sort();
        const exportData = certYears.map(y => dataStore.certificates.filter(r => String(parseInt(r.year)) === y && r.category_en === "Export CoH issued").reduce((s, c) => s + (parseFloat(c.number_of_certificates_of_health) || 0), 0));
        const vetData = certYears.map(y => dataStore.certificates.filter(r => String(parseInt(r.year)) === y && r.category_en === "Veterinary CoH issued").reduce((s, c) => s + (parseFloat(c.number_of_certificates_of_health) || 0), 0));
        createChart('certificatesChart', 'line', { labels: certYears, datasets: [
            { label: currentLang === 'ar' ? 'ØªØµØ¯ÙŠØ±' : 'Export', data: exportData, borderColor: '#007bff', fill: false, tension: 0.3 },
            { label: currentLang === 'ar' ? 'Ø¨ÙŠØ·Ø±ÙŠØ©' : 'Veterinary', data: vetData, borderColor: '#28a745', fill: false, tension: 0.3 }
        ]});

        const foodYears = [...new Set(dataStore.foodLab.map(r => String(parseInt(r.year))))].sort();
        const fitData = foodYears.map(y => dataStore.foodLab.filter(r => String(parseInt(r.year)) === y && (r.analysis_results_en === "Fit" || r.analysis_results_ar === "ØµØ§Ù„Ø­Ø©")).reduce((s, c) => s + (parseFloat(c.value) || 0), 0));
        const unfitData = foodYears.map(y => dataStore.foodLab.filter(r => String(parseInt(r.year)) === y && (r.analysis_results_en === "Unfit" || r.analysis_results_ar === "ØºÙŠØ± ØµØ§Ù„Ø­Ø©")).reduce((s, c) => s + (parseFloat(c.value) || 0), 0));
        createChart('foodLabChart', 'bar', { labels: foodYears, datasets: [
            { label: currentLang === 'ar' ? 'ØµØ§Ù„Ø­Ø©' : 'Fit', data: fitData, backgroundColor: '#28a745' },
            { label: currentLang === 'ar' ? 'ØºÙŠØ± ØµØ§Ù„Ø­Ø©' : 'Unfit', data: unfitData, backgroundColor: '#dc3545' }
        ]}, { scales: { x: { stacked: true }, y: { stacked: true } } });

        const confYears = [...new Set(dataStore.confiscated.map(r => String(parseInt(r.year))))].sort();
        const confData = confYears.map(y => dataStore.confiscated.filter(r => String(parseInt(r.year)) === y).reduce((s, c) => s + (parseFloat(c.confiscated_food_and_health_products_kg) || 0), 0));
        createChart('confiscatedChart', 'line', { labels: confYears, datasets: [{ label: currentLang === 'ar' ? 'Ø§Ù„Ù…ØµØ§Ø¯Ø±Ø§Øª (ÙƒØ¬Ù…)' : 'Confiscated (kg)', data: confData, borderColor: '#ffc107', backgroundColor: 'rgba(255,193,7,0.3)', fill: true }]});
        
        const violSourceData = dataStore.violations.filter(r => r.category_en !== 'Shops' && r.category_en !== 'Houses');
        const violYears = [...new Set(violSourceData.map(r => String(parseInt(r.year))))].sort();
        const violCats = [...new Set(violSourceData.map(r => currentLang === 'ar' ? r.category_ar : r.category_en).filter(Boolean))];
        const violData = violCats.map((cat, i) => ({
            label: cat,
            data: violYears.map(y => violSourceData.filter(r => String(parseInt(r.year)) === y && (currentLang === 'ar' ? r.category_ar : r.category_en) === cat).reduce((s, v) => s + (parseFloat(v.number_of_violations_and_cleanliness_issued_by_waste_management_public_higiene_sec) || 0), 0)),
            backgroundColor: ['#007bff','#28a745','#dc3545','#ffc107','#6f42c1','#10b981','#eab308'][i % 7]
        }));
        createChart('violationsChart', 'bar', { labels: violYears, datasets: violData }, { scales: { x: { stacked: true }, y: { stacked: true } } });

        const shopsYears = [...new Set(dataStore.shops.map(r => String(parseInt(r.year))))].sort();
        const shopsData = shopsYears.map(y => dataStore.shops.filter(r => String(parseInt(r.year)) === y).reduce((s, c) => s + (parseFloat(c.number_of_shops_visited) || 0), 0));
        createChart('shopsChart', 'line', { labels: shopsYears, datasets: [{ label: currentLang === 'ar' ? 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§Øª' : 'Shops Visited', data: shopsData, borderColor: '#17a2b8', fill: false, tension: 0.3 }]});
    }

    function renderSingleYearCharts(year) {
        const months = currentLang === 'ar' ? ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'] : ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const monthMapEn = { "January": 0, "February": 1, "March": 2, "April": 3, "May": 4, "June": 5, "July": 6, "August": 7, "September": 8, "October": 9, "November": 10, "December": 11 };

        // Helper to aggregate monthly data
        const aggregateByMonth = (data, valueField, categoryField = null, categoryValue = null) => {
            const monthlyData = Array(12).fill(0);
            const filteredData = data.filter(r => String(parseInt(r.year)) === year && (!categoryField || r[categoryField] === categoryValue));
            filteredData.forEach(r => {
                const monthIndex = monthMapEn[r.month_en];
                if (monthIndex !== undefined) {
                    monthlyData[monthIndex] += parseFloat(r[valueField]) || 0;
                }
            });
            return monthlyData;
        };

        const certs = dataStore.certificates;
        const exportData = aggregateByMonth(certs, 'number_of_certificates_of_health', 'category_en', 'Export CoH issued');
        const vetData = aggregateByMonth(certs, 'number_of_certificates_of_health', 'category_en', 'Veterinary CoH issued');
        createChart('certificatesChart', 'line', { labels: months, datasets: [
            { label: currentLang === 'ar' ? 'ØªØµØ¯ÙŠØ±' : 'Export', data: exportData, borderColor: '#007bff', fill: false, tension: 0.3 },
            { label: currentLang === 'ar' ? 'Ø¨ÙŠØ·Ø±ÙŠØ©' : 'Veterinary', data: vetData, borderColor: '#28a745', fill: false, tension: 0.3 }
        ]});

        const foodLab = dataStore.foodLab;
        const fitData = aggregateByMonth(foodLab, 'value', 'analysis_results_en', 'Fit');
        const unfitData = aggregateByMonth(foodLab, 'value', 'analysis_results_en', 'Unfit');
        createChart('foodLabChart', 'bar', { labels: months, datasets: [
            { label: currentLang === 'ar' ? 'ØµØ§Ù„Ø­Ø©' : 'Fit', data: fitData, backgroundColor: '#28a745' },
            { label: currentLang === 'ar' ? 'ØºÙŠØ± ØµØ§Ù„Ø­Ø©' : 'Unfit', data: unfitData, backgroundColor: '#dc3545' }
        ]}, { scales: { x: { stacked: true }, y: { stacked: true } } });

        const confData = aggregateByMonth(dataStore.confiscated, 'confiscated_food_and_health_products_kg');
        createChart('confiscatedChart', 'line', { labels: months, datasets: [{ label: currentLang === 'ar' ? 'Ø§Ù„Ù…ØµØ§Ø¯Ø±Ø§Øª (ÙƒØ¬Ù…)' : 'Confiscated (kg)', data: confData, borderColor: '#ffc107', backgroundColor: 'rgba(255,193,7,0.3)', fill: true }]});
        
        const violData = dataStore.violations.filter(r => String(parseInt(r.year)) === year && r.category_en !== 'Shops' && r.category_en !== 'Houses');
        const violCats = [...new Set(violData.map(r => currentLang === 'ar' ? r.category_ar : r.category_en).filter(Boolean))];
        const violDatasets = violCats.map((cat, i) => ({
            label: cat,
            data: aggregateByMonth(violData, 'number_of_violations_and_cleanliness_issued_by_waste_management_public_higiene_sec', currentLang === 'ar' ? 'category_ar' : 'category_en', cat),
            backgroundColor: ['#007bff','#28a745','#dc3545','#ffc107','#6f42c1','#10b981','#eab308'][i % 7]
        }));
        createChart('violationsChart', 'bar', { labels: months, datasets: violDatasets }, { scales: { x: { stacked: true }, y: { stacked: true } } });

        const shopsData = aggregateByMonth(dataStore.shops, 'number_of_shops_visited');
        createChart('shopsChart', 'line', { labels: months, datasets: [{ label: currentLang === 'ar' ? 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§Øª' : 'Shops Visited', data: shopsData, borderColor: '#17a2b8', fill: false, tension: 0.3 }]});
    }

    const getOrCreateTooltip = (chart) => {
      let tooltipEl = chart.canvas.parentNode.querySelector('#chartjs-tooltip');

      if (!tooltipEl) {
        tooltipEl = document.createElement('div');
        tooltipEl.id = 'chartjs-tooltip';
        tooltipEl.innerHTML = '<table></table>';
        chart.canvas.parentNode.appendChild(tooltipEl);
      }

      return tooltipEl;
    };

    const externalTooltipHandler = (context) => {
      const { chart, tooltip } = context;
      const tooltipEl = getOrCreateTooltip(chart);

      if (tooltip.opacity === 0) {
        tooltipEl.style.opacity = 0;
        return;
      }

      const tableRoot = tooltipEl.querySelector('table');
      tableRoot.innerHTML = ''; // Clear previous content

      if (tooltip.title.length > 0) {
        const tableHead = document.createElement('thead');
        const tr = document.createElement('tr');
        const th = document.createElement('th');
        th.textContent = tooltip.title[0];
        tr.appendChild(th);
        tableHead.appendChild(tr);
        tableRoot.appendChild(tableHead);
      }

      const tableBody = document.createElement('tbody');
      tooltip.body.forEach((bodyItem, i) => {
        const colors = tooltip.labelColors[i];
        const dataPoint = tooltip.dataPoints[i];
        const datasetLabel = dataPoint.dataset.label || '';
        const value = dataPoint.formattedValue;

        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.className = 'tooltip-body-item';

        const colorBox = document.createElement('span');
        colorBox.className = 'tooltip-color-box';
        colorBox.style.backgroundColor = colors.backgroundColor;
        colorBox.style.borderColor = colors.borderColor;
        colorBox.style.borderWidth = '2px';

        const text = document.createTextNode(` ${datasetLabel}: ${value}`);

        td.appendChild(colorBox);
        td.appendChild(text);
        tr.appendChild(td);
        tableBody.appendChild(tr);
      });

      tableRoot.appendChild(tableBody);

      const { offsetLeft: positionX, offsetTop: positionY } = chart.canvas;
      tooltipEl.style.opacity = 1;
      tooltipEl.style.left = positionX + tooltip.caretX + 'px';
      tooltipEl.style.top = positionY + tooltip.caretY + 'px';
      tooltipEl.style.transform = 'translate(-50%, -115%)'; // Position above the caret
    };

    function createChart(canvasId, type, data, options = {}) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const defaultOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              legend: { position: 'top' },
              tooltip: {
                enabled: false,
                external: externalTooltipHandler
              }
            },
            scales: { y: { beginAtZero: true } },
            interaction: {
              mode: 'index',
              intersect: false
            },
            elements: {
              bar: {
                borderWidth: 1,
                hoverBorderWidth: 3
              },
              point: {
                radius: 3,
                hoverRadius: 6
              }
            }
        };
        chartInstances.push(new Chart(ctx, { type, data, options: { ...defaultOptions, ...options } }));
    }

    function renderInsights() {
      const insights = translations[currentLang].insights;
      document.getElementById('insightsList').innerHTML = insights.map(ins =>
        `<div class="insight-item"><div class="insight-icon">${ins.icon}</div><div class="insight-text"><h4>${ins.title}</h4><p>${ins.text}</p></div></div>`
      ).join('');
    }
  </script>
</body>
</html>
