<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ajman Health & Food Safety Dashboard</title>
  <link rel="icon" href="assets/ajman-data-logo.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f7fa; color: #2c3e50; margin: 0; }
    .header { display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%); color: white; padding: 1.5rem 2rem; }
    .header .logos { display: flex; gap: 1.5rem; align-items: center; }
    .header img { height: 56px; background: white; border-radius: 8px; padding: 3px; }
    .header h1 { font-size: 2rem; margin: 0 0 0 1rem; }
    .lang-toggle { font-size: 1rem; }
    .lang-toggle button { background: #fff; color: #1e3a5f; border: none; font-weight: bold; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; margin-left: 0.5rem; }
    .lang-toggle button.active { background: #7c3aed; color: #fff; }
    .metrics-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; padding: 2rem; max-width: 1400px; margin: 0 auto; }
    .metric-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; }
    .metric-title { color: #7c3aed; font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }
    .metric-value { font-size: 2.1rem; font-weight: 700; color: #1e3a5f; }
    .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 2rem; padding: 0 2rem 2rem; max-width: 1400px; margin: 0 auto; }
    .chart-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .chart-card h3 { font-size: 1.15rem; margin-bottom: 1rem; color: #1e3a5f; }
    .chart-container { position: relative; height: 320px; }
    .chart-narrative { font-size: 0.95rem; margin-top: 0.5rem; color: #444; }
    .insights-section { background: white; margin: 2rem; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 1360px; margin: 2rem auto; }
    .insights-section h2 { color: #1e3a5f; margin-bottom: 1.5rem; font-size: 1.3rem; }
    .insight-item { display: flex; align-items: flex-start; margin-bottom: 1.2rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid #7c3aed; }
    .insight-icon { font-size: 1.5rem; margin-right: 1rem; }
    .insight-text h4 { color: #1e3a5f; margin-bottom: 0.5rem; }
    .footer { background: #1e3a5f; color: white; padding: 1.5rem; text-align: center; margin-top: 2rem; }
    .footer p { margin: 0.5rem 0; opacity: 0.9; }
    .footer a { color: #93c5fd; text-decoration: underline; }
    .footer a:hover { text-decoration: underline; }
    @media (max-width: 768px) {
      .header { flex-direction: column; align-items: flex-start; }
      .charts-container { grid-template-columns: 1fr; }
      .metrics-container { grid-template-columns: 1fr; }
      .header img { height: 40px; }
    }
  </style>
</head>
<body>
  <div class="header" id="header">
    <div class="logos">
      <img src="assets/ajman-data-logo.png" alt="Ajman Data Logo" />
      <img src="assets/ajman-vision-2030-logo.png" alt="Ajman Vision 2030 Logo" />
      <h1 id="dashboardTitle"></h1>
    </div>
    <div class="lang-toggle" id="langToggle">
      <button id="enBtn" class="active" onclick="setLang('en')">English</button>
      <button id="arBtn" onclick="setLang('ar')">العربية</button>
    </div>
  </div>
  <p id="dashboardSubtitle" style="text-align:center; margin:1rem 0 0.5rem;"></p>
  <div class="metrics-container" id="metricsContainer"></div>
  <div class="charts-container" id="chartsContainer"></div>
  <div class="insights-section" id="insightsSection">
    <h2 id="insightsTitle"></h2>
    <div id="insightsList"></div>
  </div>
  <div class="footer">
    <p id="footerSource"></p>
    <p id="footerVision"></p>
    <p>
      <a href="https://drive.google.com/file/d/117tCPxZFDSuK42dQhU_oRK0INWZ8Su2k/view" target="_blank">
        Ajman Vision 2030 [PDF] | رؤية عجمان 2030 [ملف PDF]
      </a>
    </p>
    <p>
      Data Source: 
      <a href="https://data.ajman.ae" target="_blank">data.ajman.ae</a> | 
      <a href="https://data.ajman.ae" target="_blank">بوابة بيانات عجمان</a>
    </p>
    <p>Created by Haseeb Juma | © 2025 - Ajman University</p>
  </div>
  <script>
    // Translation object as before (omitted here for brevity, use same as previous)
    const translations = { /* ... (use the same translation object as previous code) ... */ };

    let currentLang = 'en';

    function setLang(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;
      document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
      document.getElementById('enBtn').classList.toggle('active', lang === 'en');
      document.getElementById('arBtn').classList.toggle('active', lang === 'ar');
      document.getElementById('dashboardTitle').textContent = translations[lang].dashboardTitle;
      document.getElementById('dashboardSubtitle').textContent = translations[lang].dashboardSubtitle;
      document.getElementById('insightsTitle').textContent = translations[lang].insightsTitle;
      document.getElementById('footerSource').innerHTML = translations[lang].footerSource;
      document.getElementById('footerVision').textContent = translations[lang].footerVision;
      renderMetrics();
      renderCharts();
      renderInsights();
    }

    // JSON file paths
    const files = {
      certificates: 'data/medical-certificates-issued.json',
      foodLab: 'data/food-laboratory-test-results.json',
      confiscated: 'data/confiscated-food-and-health-products.json',
      violations: 'data/warnings-and-public-health-violations.json',
      shops: 'data/shops-visited.json'
    };
    let dataStore = {};

    Promise.all(Object.entries(files).map(([k, url]) =>
      fetch(url).then(r => r.json()).then(data => [k, data])
    )).then(results => {
      results.forEach(([k, d]) => dataStore[k] = d);
      setLang(currentLang);
    });

    function renderMetrics() {
      const metrics = [];
      // Shops Inspected
      const shops = dataStore.shops || [];
      const totalShops = shops.reduce((sum, row) => sum + (parseFloat(row.number_of_shops_visited) || 0), 0);
      metrics.push({
        title: translations[currentLang].metrics[0].title,
        value: totalShops.toLocaleString()
      });
      // Food Safety Pass Rate
      const foodLab = dataStore.foodLab || [];
      const fit = foodLab.filter(r => (r.Analysis_Results_EN === "Fit" || r.analysis_results_en === "Fit" || r.Analysis_Results_AR === "صالحة" || r.analysis_results_ar === "صالحة"))
        .reduce((sum, row) => sum + (parseFloat(row.value) || 0), 0);
      const unfit = foodLab.filter(r => (r.Analysis_Results_EN === "Unfit" || r.analysis_results_en === "Unfit" || r.Analysis_Results_AR === "غير صالحة" || r.analysis_results_ar === "غير صالحة"))
        .reduce((sum, row) => sum + (parseFloat(row.value) || 0), 0);
      const passRate = (fit + unfit) > 0 ? (fit / (fit + unfit) * 100).toFixed(1) : "0";
      metrics.push({
        title: translations[currentLang].metrics[1].title,
        value: passRate + "%"
      });
      // Violations Issued
      const violations = dataStore.violations || [];
      const totalViol = violations.reduce((sum, row) => sum + (parseFloat(row.number_of_violations_and_cleanliness_issued_by_waste_management_and_public_higiene_sec) || 0), 0);
      metrics.push({
        title: translations[currentLang].metrics[2].title,
        value: totalViol.toLocaleString()
      });
      // Products Confiscated
      const conf = dataStore.confiscated || [];
      const totalConf = conf.reduce((sum, row) => sum + (parseFloat(row.confiscated_food_and_health_products_kg) || 0), 0);
      metrics.push({
        title: translations[currentLang].metrics[3].title,
        value: (totalConf/1000).toFixed(1) + " t"
      });
      // Export Certificates
      const cert = dataStore.certificates || [];
      const totalExport = cert.filter(r => (r.Category_EN === "Export CoH issued" || r.category_en === "Export CoH issued" || r.Category_AR === "شهادات صحية تصدير" || r.category_ar === "شهادات صحية تصدير"))
        .reduce((sum, row) => sum + (parseFloat(row.number_of_certificates_of_health) || 0), 0);
      metrics.push({
        title: translations[currentLang].metrics[4].title,
        value: totalExport.toLocaleString()
      });
      document.getElementById('metricsContainer').innerHTML = metrics.map(m =>
        `<div class="metric-card"><div class="metric-title">${m.title}</div><div class="metric-value">${m.value}</div></div>`
      ).join('');
    }

    let chartInstances = [];
    function renderCharts() {
      chartInstances.forEach(ch => ch.destroy && ch.destroy());
      chartInstances = [];
      const chartsDiv = document.getElementById('chartsContainer');
      chartsDiv.innerHTML = '';
      // Medical Certificates Chart
      const cert = dataStore.certificates || [];
      const certByYear = {};
      cert.forEach(row => {
        let year = row.Year || row.year;
        if (year === undefined) year = row['year'];
        year = year ? String(parseInt(year)) : null;
        const cat = (currentLang === 'ar' ? (row.Category_AR || row.category_ar) : (row.Category_EN || row.category_en)) || '';
        const count = parseFloat(row.Number_of_Certificates_of_Health || row.number_of_certificates_of_health) || 0;
        if (!year || !cat) return;
        if (!certByYear[year]) certByYear[year] = {Export:0, Veterinary:0};
        if (cat.includes(currentLang === 'ar' ? 'تصدير' : 'Export')) certByYear[year].Export += count;
        else if (cat.includes(currentLang === 'ar' ? 'بيطرية' : 'Veterinary')) certByYear[year].Veterinary += count;
      });
      const yearsCert = Object.keys(certByYear).sort();
      const exportData = yearsCert.map(y => certByYear[y].Export);
      const vetData = yearsCert.map(y => certByYear[y].Veterinary);
      chartsDiv.innerHTML += `<div class="chart-card"><h3>${translations[currentLang].charts[0]}</h3><div class="chart-container"><canvas id="certificatesChart"></canvas></div><div class="chart-narrative">${translations[currentLang].chartNarratives[0]}</div></div>`;
      chartInstances.push(new Chart(document.getElementById('certificatesChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: yearsCert,
          datasets: [
            {label: currentLang === 'ar' ? 'تصدير' : 'Export', data: exportData, borderColor: '#007bff', fill:false, tension:0.3},
            {label: currentLang === 'ar' ? 'بيطرية' : 'Veterinary', data: vetData, borderColor: '#28a745', fill:false, tension:0.3}
          ]
        },
        options: {responsive:true, plugins: {legend: {position: 'top'}}, scales: {y: {beginAtZero:true}}}
      }));
      // Food Laboratory Test Results Chart
      const foodLab = dataStore.foodLab || [];
      const foodByYear = {};
      foodLab.forEach(row => {
        let year = row.year || row.Year;
        year = year ? String(parseInt(year)) : null;
        const result = (currentLang === 'ar' ? (row.Analysis_Results_AR || row.analysis_results_ar) : (row.Analysis_Results_EN || row.analysis_results_en)) || '';
        const val = parseFloat(row.value) || 0;
        if (!year || !result) return;
        if (!foodByYear[year]) foodByYear[year] = {Fit:0, Unfit:0};
        if (result === (currentLang === 'ar' ? 'صالحة' : 'Fit')) foodByYear[year].Fit += val;
        else if (result === (currentLang === 'ar' ? 'غير صالحة' : 'Unfit')) foodByYear[year].Unfit += val;
      });
      const yearsFood = Object.keys(foodByYear).sort();
      const fitData = yearsFood.map(y => foodByYear[y].Fit);
      const unfitData = yearsFood.map(y => foodByYear[y].Unfit);
      chartsDiv.innerHTML += `<div class="chart-card"><h3>${translations[currentLang].charts[1]}</h3><div class="chart-container"><canvas id="foodLabChart"></canvas></div><div class="chart-narrative">${translations[currentLang].chartNarratives[1]}</div></div>`;
      chartInstances.push(new Chart(document.getElementById('foodLabChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: yearsFood,
          datasets: [
            {label: currentLang === 'ar' ? 'صالحة' : 'Fit', data: fitData, backgroundColor: '#28a745'},
            {label: currentLang === 'ar' ? 'غير صالحة' : 'Unfit', data: unfitData, backgroundColor: '#dc3545'}
          ]
        },
        options: {responsive:true, plugins: {legend: {position: 'top'}}, scales: {y: {beginAtZero:true}, x: {stacked:true}}, interaction: {mode: 'index', intersect: false}, stacked: true}
      }));
      // Confiscated Food & Health Products Chart
      const conf = dataStore.confiscated || [];
      const confByYear = {};
      conf.forEach(row => {
        let year = row.year || row.Year;
        year = year ? String(parseInt(year)) : null;
        const val = parseFloat(row.confiscated_food_and_health_products_kg) || 0;
        if (!year) return;
        confByYear[year] = (confByYear[year] || 0) + val;
      });
      const yearsConf = Object.keys(confByYear).sort();
      const confData = yearsConf.map(y => confByYear[y]);
      chartsDiv.innerHTML += `<div class="chart-card"><h3>${translations[currentLang].charts[2]}</h3><div class="chart-container"><canvas id="confiscatedChart"></canvas></div><div class="chart-narrative">${translations[currentLang].chartNarratives[2]}</div></div>`;
      chartInstances.push(new Chart(document.getElementById('confiscatedChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: yearsConf,
          datasets: [{
            label: currentLang === 'ar' ? 'المصادرات (كجم)' : 'Confiscated (kg)',
            data: confData,
            borderColor: '#ffc107',
            fill: true,
            backgroundColor: 'rgba(255, 193, 7, 0.3)',
            tension: 0.3
          }]
        },
        options: {responsive:true, plugins: {legend: {position: 'top'}}, scales: {y: {beginAtZero:true}}}
      }));
      // Warnings & Violations by Category
      const violations = dataStore.violations || [];
      const violByYearCat = {};
      violations.forEach(row => {
        let year = row.year || row.Year;
        year = year ? String(parseInt(year)) : null;
        const cat = (currentLang === 'ar' ? (row.Category_AR || row.category_ar) : (row.Category_EN || row.category_en)) || 'Other';
        const val = parseFloat(row.number_of_violations_and_cleanliness_issued_by_waste_management_and_public_higiene_sec) || 0;
        if (!year || !cat) return;
        if (!violByYearCat[cat]) violByYearCat[cat] = {};
        violByYearCat[cat][year] = (violByYearCat[cat][year] || 0) + val;
      });
      const yearsViol = [...new Set(violations.map(r => {
        let y = r.year || r.Year;
        return y ? String(parseInt(y)) : null;
      }).filter(Boolean))].sort();
      const categories = Object.keys(violByYearCat);
      const datasetsViol = categories.map((cat, i) => ({
        label: cat,
        data: yearsViol.map(y => violByYearCat[cat][y] || 0),
        backgroundColor: ['#007bff','#28a745','#dc3545','#ffc107','#6f42c1'][i % 5]
      }));
      chartsDiv.innerHTML += `<div class="chart-card"><h3>${translations[currentLang].charts[3]}</h3><div class="chart-container"><canvas id="violationsChart"></canvas></div><div class="chart-narrative">${translations[currentLang].chartNarratives[3]}</div></div>`;
      chartInstances.push(new Chart(document.getElementById('violationsChart').getContext('2d'), {
        type: 'bar',
        data: { labels: yearsViol, datasets: datasetsViol },
        options: {responsive:true, plugins: {legend: {position: 'top'}}, scales: {y: {beginAtZero:true}, x: {stacked:true}}, interaction: {mode: 'index', intersect: false}, stacked: true}
      }));
      // Shops Visited Chart
      const shops = dataStore.shops || [];
      const shopsByYear = {};
      shops.forEach(row => {
        let year = row.year || row.Year;
        year = year ? String(parseInt(year)) : null;
        const val = parseFloat(row.number_of_shops_visited) || 0;
        if (!year) return;
        shopsByYear[year] = (shopsByYear[year] || 0) + val;
      });
      const yearsShops = Object.keys(shopsByYear).sort();
      const shopsData = yearsShops.map(y => shopsByYear[y]);
      chartsDiv.innerHTML += `<div class="chart-card"><h3>${translations[currentLang].charts[4]}</h3><div class="chart-container"><canvas id="shopsChart"></canvas></div><div class="chart-narrative">${translations[currentLang].chartNarratives[4]}</div></div>`;
      chartInstances.push(new Chart(document.getElementById('shopsChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: yearsShops,
          datasets: [{
            label: currentLang === 'ar' ? 'عدد المحلات' : 'Shops Visited',
            data: shopsData,
            borderColor: '#17a2b8',
            fill: false,
            tension: 0.3
          }]
        },
        options: {responsive:true, plugins: {legend: {position: 'top'}}, scales: {y: {beginAtZero:true}}}
      }));
    }

    function renderInsights() {
      const insights = translations[currentLang].insights;
      document.getElementById('insightsList').innerHTML = insights.map(ins =>
        `<div class="insight-item"><div class="insight-icon">${ins.icon}</div><div class="insight-text"><h4>${ins.title}</h4><p>${ins.text}</p></div></div>`
      ).join('');
    }
  </script>
</body>
</html>
