<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ajman Health & Food Safety Dashboard</title>
  <link rel="icon" href="assets/ajman-data-logo.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f7fa; color: #2c3e50; margin: 0; }
    .header { display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%); color: white; padding: 1.5rem 2rem; }
    .header .logos { display: flex; gap: 1.5rem; align-items: center; }
    .header img { height: 56px; background: white; border-radius: 8px; padding: 3px; }
    .header h1 { font-size: 2rem; margin: 0 0 0 1rem; }
    .lang-toggle { font-size: 1rem; }
    .lang-toggle button { background: #fff; color: #1e3a5f; border: none; font-weight: bold; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; margin-left: 0.5rem; }
    .lang-toggle button.active { background: #7c3aed; color: #fff; }
    .metrics-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; padding: 2rem; max-width: 1400px; margin: 0 auto; }
    .metric-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; }
    .metric-title { color: #7c3aed; font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }
    .metric-value { font-size: 2.1rem; font-weight: 700; color: #1e3a5f; }
    .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 2rem; padding: 0 2rem 2rem; max-width: 1400px; margin: 0 auto; }
    .chart-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .chart-card h3 { font-size: 1.15rem; margin-bottom: 1rem; color: #1e3a5f; }
    .chart-container { position: relative; height: 320px; }
    .chart-narrative { font-size: 0.95rem; margin-top: 0.5rem; color: #444; }
    .insights-section { background: white; margin: 2rem; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 1360px; margin: 2rem auto; }
    .insights-section h2 { color: #1e3a5f; margin-bottom: 1.5rem; font-size: 1.3rem; }
    .insight-item { display: flex; align-items: flex-start; margin-bottom: 1.2rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid #7c3aed; }
    .insight-icon { font-size: 1.5rem; margin-right: 1rem; }
    .insight-text h4 { color: #1e3a5f; margin-bottom: 0.5rem; }
    .footer { background: #1e3a5f; color: white; padding: 1.5rem; text-align: center; margin-top: 2rem; }
    .footer p { margin: 0.5rem 0; opacity: 0.9; }
    .footer a { color: #93c5fd; text-decoration: underline; }
    .footer a:hover { text-decoration: underline; }
    .debug-info { background: #fff3cd; border: 1px solid #ffeaa7; padding: 1rem; margin: 2rem; border-radius: 8px; font-family: monospace; font-size: 0.9rem; }
    .loading-indicator { text-align: center; padding: 2rem; color: #666; }
    @media (max-width: 768px) {
      .header { flex-direction: column; align-items: flex-start; }
      .charts-container { grid-template-columns: 1fr; }
      .metrics-container { grid-template-columns: 1fr; }
      .header img { height: 40px; }
    }
  </style>
</head>
<body>
  <div class="header" id="header">
    <div class="logos">
      <img src="assets/ajman-data-logo.png" alt="Ajman Data Logo" onerror="this.style.display='none'" />
      <img src="assets/ajman-vision-2030-logo.png" alt="Ajman Vision 2030 Logo" onerror="this.style.display='none'" />
      <h1 id="dashboardTitle"></h1>
    </div>
    <div class="lang-toggle" id="langToggle">
      <button id="enBtn" class="active" onclick="setLang('en')">English</button>
      <button id="arBtn" onclick="setLang('ar')">العربية</button>
    </div>
  </div>
  <p id="dashboardSubtitle" style="text-align:center; margin:1rem 0 0.5rem;"></p>
  
  <!-- Debug information panel -->
  <div id="debugInfo" class="debug-info" style="display: none;">
    <h4>Debug Information:</h4>
    <div id="debugContent"></div>
  </div>
  
  <!-- Loading indicator -->
  <div id="loadingIndicator" class="loading-indicator">
    <p>Loading dashboard data...</p>
  </div>
  
  <div class="metrics-container" id="metricsContainer"></div>
  <div class="charts-container" id="chartsContainer"></div>
  <div class="insights-section" id="insightsSection">
    <h2 id="insightsTitle"></h2>
    <div id="insightsList"></div>
  </div>
  <div class="footer">
    <p id="footerSource"></p>
    <p id="footerVision"></p>
    <p>
      <a href="https://drive.google.com/file/d/117tCPxZFDSuK42dQhU_oRK0INWZ8Su2k/view" target="_blank">
        Ajman Vision 2030 [PDF] | رؤية عجمان 2030 [ملف PDF]
      </a>
    </p>
    <p>
      Data Source: 
      <a href="https://data.ajman.ae" target="_blank">data.ajman.ae</a> | 
      <a href="https://data.ajman.ae" target="_blank">بوابة بيانات عجمان</a>
    </p>
    <p>Created by Haseeb Juma | © 2025 - Ajman University</p>
    <p style="margin-top: 1rem;">
      <button onclick="toggleDebug()" style="background: #7c3aed; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
        Toggle Debug Info
      </button>
    </p>
  </div>
  <script>
    // Enhanced translation object
    const translations = {
      en: {
        dashboardTitle: "Ajman Health & Food Safety Dashboard",
        dashboardSubtitle: "Empowering Ajman's Future: Data-Driven Health for All",
        metrics: [
          { title: "Shops Inspected" },
          { title: "Food Safety Pass Rate" },
          { title: "Violations Issued" },
          { title: "Products Confiscated" },
          { title: "Export Certificates" }
        ],
        charts: [
          "Medical Certificates Issued (Export & Veterinary)",
          "Food Laboratory Test Results (Fit vs Unfit)",
          "Confiscated Food & Health Products (kg)",
          "Warnings & Violations by Category",
          "Shops Visited for Inspection"
        ],
        chartNarratives: [
          "Ajman's export and veterinary health certification activity over time. Export certifications dominate, reflecting Ajman's strong food export oversight.",
          "Food safety testing results: steady improvement in 'Fit' samples, with a declining trend in 'Unfit' results, supporting Vision 2030 sustainability.",
          "Confiscated product volumes indicate active enforcement. Spikes often follow increased inspections or targeted campaigns.",
          "Most violations are issued to companies, suggesting targeted education/enforcement could yield quick wins for public health.",
          "Inspection activity shows Ajman's preventive approach to health and food safety, with peaks during high-risk periods."
        ],
        insightsTitle: "Key Insights & Vision 2030 Alignment",
        insights: [
          {
            icon: "🌱",
            title: "Sustainability in Action",
            text: "Reduction in unsafe food and increased preventive enforcement support Ajman's sustainability goals."
          },
          {
            icon: "🤝",
            title: "Community Well-being",
            text: "Transparent health data empowers citizens and supports inclusive, healthy communities."
          },
          {
            icon: "💡",
            title: "Innovation for Impact",
            text: "Real-time, interactive analytics enable evidence-based policy and government excellence."
          },
          {
            icon: "📈",
            title: "Human Capital Development",
            text: "Open data and insights foster education, research, and a future-ready society."
          }
        ],
        footerSource: 'Data Source: <a href="https://data.ajman.ae" target="_blank">data.ajman.ae</a>',
        footerVision: "Aligned with Ajman Vision 2030 for a sustainable, healthy, and inclusive future."
      },
      ar: {
        dashboardTitle: "لوحة بيانات الصحة وسلامة الغذاء عجمان",
        dashboardSubtitle: "تمكين مستقبل عجمان: الصحة للجميع بالبيانات",
        metrics: [
          { title: "المحلات التي تم تفتيشها" },
          { title: "معدل نجاح سلامة الأغذية" },
          { title: "المخالفات الصادرة" },
          { title: "المنتجات المصادرة" },
          { title: "شهادات التصدير" }
        ],
        charts: [
          "الشهادات الصحية الصادرة (تصدير وبيطرية)",
          "نتائج اختبارات مختبر الأغذية (صالحة/غير صالحة)",
          "المواد الغذائية والمنتجات الصحية المصادرة (كجم)",
          "الإنذارات والمخالفات حسب الفئة",
          "المحلات التي تمت زيارتها للتفتيش"
        ],
        chartNarratives: [
          "نشاط إصدار الشهادات الصحية للتصدير والبيطرية في عجمان عبر السنوات. شهادات التصدير تتصدر المشهد، مما يعكس الرقابة القوية على التصدير الغذائي.",
          "نتائج اختبارات سلامة الأغذية: تحسن مستمر في العينات الصالحة وتراجع في غير الصالحة، دعمًا لاستدامة رؤية عجمان 2030.",
          "كميات المنتجات المصادرة تعكس فعالية الإنفاذ. الارتفاعات غالبًا ما تتبع حملات تفتيش أو حملات موجهة.",
          "معظم المخالفات تصدر للشركات، مما يشير إلى أن التوعية أو الإنفاذ الموجه قد يحقق نتائج سريعة للصحة العامة.",
          "نشاط التفتيش يُظهر نهج عجمان الوقائي في الصحة وسلامة الغذاء مع ذروات في الفترات عالية المخاطر."
        ],
        insightsTitle: "رؤى رئيسية ومحاذاة مع رؤية عجمان 2030",
        insights: [
          {
            icon: "🌱",
            title: "الاستدامة قيد التنفيذ",
            text: "انخفاض الأغذية غير الصالحة وزيادة الإنفاذ الوقائي يدعم أهداف الاستدامة في عجمان."
          },
          {
            icon: "🤝",
            title: "رفاهية المجتمع",
            text: "الشفافية في بيانات الصحة تمكّن المواطنين وتدعم مجتمعات صحية شاملة."
          },
          {
            icon: "💡",
            title: "الابتكار من أجل التأثير",
            text: "التحليلات التفاعلية في الوقت الفعلي تمكن السياسات المبنية على الأدلة والتميز الحكومي."
          },
          {
            icon: "📈",
            title: "تطوير رأس المال البشري",
            text: "البيانات المفتوحة والرؤى تدعم التعليم والبحث ومجتمع المستقبل."
          }
        ],
        footerSource: 'المصدر: <a href="https://data.ajman.ae" target="_blank">بوابة بيانات عجمان</a>',
        footerVision: "تماشياً مع رؤية عجمان 2030 لمستقبل مستدام وصحي وشامل."
      }
    };

    let currentLang = 'en';
    let dataStore = {};
    let loadingErrors = [];

    // Sample fallback data for testing when files aren't available
    const sampleData = {
      certificates: [
        {year: 2020, category_en: "Export CoH issued", category_ar: "شهادات صحية تصدير", number_of_certificates_of_health: 1250},
        {year: 2021, category_en: "Export CoH issued", category_ar: "شهادات صحية تصدير", number_of_certificates_of_health: 1400},
        {year: 2022, category_en: "Export CoH issued", category_ar: "شهادات صحية تصدير", number_of_certificates_of_health: 1600},
        {year: 2020, category_en: "Veterinary CoH issued", category_ar: "شهادات صحية بيطرية", number_of_certificates_of_health: 850},
        {year: 2021, category_en: "Veterinary CoH issued", category_ar: "شهادات صحية بيطرية", number_of_certificates_of_health: 920},
        {year: 2022, category_en: "Veterinary CoH issued", category_ar: "شهادات صحية بيطرية", number_of_certificates_of_health: 1050}
      ],
      foodLab: [
        {year: 2020, analysis_results_en: "Fit", analysis_results_ar: "صالحة", value: 1850},
        {year: 2021, analysis_results_en: "Fit", analysis_results_ar: "صالحة", value: 1950},
        {year: 2022, analysis_results_en: "Fit", analysis_results_ar: "صالحة", value: 2100},
        {year: 2020, analysis_results_en: "Unfit", analysis_results_ar: "غير صالحة", value: 150},
        {year: 2021, analysis_results_en: "Unfit", analysis_results_ar: "غير صالحة", value: 120},
        {year: 2022, analysis_results_en: "Unfit", analysis_results_ar: "غير صالحة", value: 95}
      ],
      confiscated: [
        {year: 2020, confiscated_food_and_health_products_kg: 2500},
        {year: 2021, confiscated_food_and_health_products_kg: 1800},
        {year: 2022, confiscated_food_and_health_products_kg: 2200}
      ],
      violations: [
        {year: 2020, category_en: "Companies", category_ar: "شركات", number_of_violations_and_cleanliness_issued_by_waste_management_public_higiene_sec: 45},
        {year: 2021, category_en: "Companies", category_ar: "شركات", number_of_violations_and_cleanliness_issued_by_waste_management_public_higiene_sec: 52},
        {year: 2022, category_en: "Companies", category_ar: "شركات", number_of_violations_and_cleanliness_issued_by_waste_management_public_higiene_sec: 38},
        {year: 2020, category_en: "Individuals", category_ar: "أفراد", number_of_violations_and_cleanliness_issued_by_waste_management_public_higiene_sec: 18},
        {year: 2021, category_en: "Individuals", category_ar: "أفراد", number_of_violations_and_cleanliness_issued_by_waste_management_public_higiene_sec: 22},
        {year: 2022, category_en: "Individuals", category_ar: "أفراد", number_of_violations_and_cleanliness_issued_by_waste_management_public_higiene_sec: 15}
      ],
      shops: [
        {year: 2020, number_of_shops_visited: 450},
        {year: 2021, number_of_shops_visited: 520},
        {year: 2022, number_of_shops_visited: 580}
      ]
    };

    // Enhanced data loading with robust error handling
    const files = {
      certificates: 'data/medical-certificates-issued.json',
      foodLab: 'data/food-laboratory-test-results.json',
      confiscated: 'data/confiscated-food-and-health-products.json',
      violations: 'data/warnings-and-public-health-violations.json',
      shops: 'data/shops-visited.json'
    };

    function logDebug(message, data = null) {
      console.log('[Dashboard Debug]', message, data);
      const debugContent = document.getElementById('debugContent');
      if (debugContent) {
        const timestamp = new Date().toLocaleTimeString();
        debugContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        if (data) {
          debugContent.innerHTML += `<div style="margin-left: 20px; color: #666;">${JSON.stringify(data, null, 2)}</div>`;
        }
      }
    }

    function toggleDebug() {
      const debugInfo = document.getElementById('debugInfo');
      debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
    }

    async function loadDataWithFallback() {
      logDebug('Starting data loading process...');
      document.getElementById('loadingIndicator').style.display = 'block';

      try {
        // Attempt to load each file individually with error handling
        const loadPromises = Object.entries(files).map(async ([key, url]) => {
          try {
            logDebug(`Attempting to load: ${url}`);
            const response = await fetch(url);
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            logDebug(`Successfully loaded ${key}`, { recordCount: data.length });
            return [key, data];
          } catch (error) {
            const errorMsg = `Failed to load ${key} from ${url}: ${error.message}`;
            logDebug(errorMsg);
            loadingErrors.push(errorMsg);
            
            // Use sample data as fallback
            logDebug(`Using sample data for ${key}`);
            return [key, sampleData[key] || []];
          }
        });

        const results = await Promise.all(loadPromises);
        
        // Store all loaded data
        results.forEach(([key, data]) => {
          dataStore[key] = data;
        });

        logDebug('Data loading completed', {
          loadedFiles: Object.keys(dataStore),
          errors: loadingErrors.length
        });

      } catch (error) {
        logDebug('Critical error during data loading', error);
        // Use all sample data as complete fallback
        dataStore = { ...sampleData };
      }

      // Hide loading indicator and initialize dashboard
      document.getElementById('loadingIndicator').style.display = 'none';
      setLang(currentLang);
    }

    function setLang(lang) {
      logDebug(`Setting language to: ${lang}`);
      currentLang = lang;
      document.documentElement.lang = lang;
      document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
      document.getElementById('enBtn').classList.toggle('active', lang === 'en');
      document.getElementById('arBtn').classList.toggle('active', lang === 'ar');
      document.getElementById('dashboardTitle').textContent = translations[lang].dashboardTitle;
      document.getElementById('dashboardSubtitle').textContent = translations[lang].dashboardSubtitle;
      document.getElementById('insightsTitle').textContent = translations[lang].insightsTitle;
      document.getElementById('footerSource').innerHTML = translations[lang].footerSource;
      document.getElementById('footerVision').textContent = translations[lang].footerVision;
      
      // Only render if we have data
      if (Object.keys(dataStore).length > 0) {
        renderMetrics();
        renderCharts();
        renderInsights();
      }
    }

    function renderMetrics() {
      logDebug('Rendering metrics...');
      const metrics = [];
      
      try {
        // Shops Inspected
        const shops = dataStore.shops || [];
        const totalShops = shops.reduce((sum, row) => sum + (parseFloat(row.number_of_shops_visited) || 0), 0);
        metrics.push({
          title: translations[currentLang].metrics[0].title,
          value: totalShops.toLocaleString()
        });

        // Food Safety Pass Rate
        const foodLab = dataStore.foodLab || [];
        const fit = foodLab.filter(r => (r.analysis_results_en === "Fit" || r.analysis_results_ar === "صالحة"))
          .reduce((sum, row) => sum + (parseFloat(row.value) || 0), 0);
        const unfit = foodLab.filter(r => (r.analysis_results_en === "Unfit" || r.analysis_results_ar === "غير صالحة"))
          .reduce((sum, row) => sum + (parseFloat(row.value) || 0), 0);
        const passRate = (fit + unfit) > 0 ? (fit / (fit + unfit) * 100).toFixed(1) : "0";
        metrics.push({
          title: translations[currentLang].metrics[1].title,
          value: passRate + "%"
        });

        // Violations Issued
        const violations = dataStore.violations || [];
        const totalViol = violations.reduce((sum, row) => sum + (parseFloat(row.number_of_violations_and_cleanliness_issued_by_waste_management_public_higiene_sec) || 0), 0);
        metrics.push({
          title: translations[currentLang].metrics[2].title,
          value: totalViol.toLocaleString()
        });

        // Products Confiscated
        const conf = dataStore.confiscated || [];
        const totalConf = conf.reduce((sum, row) => sum + (parseFloat(row.confiscated_food_and_health_products_kg) || 0), 0);
        metrics.push({
          title: translations[currentLang].metrics[3].title,
          value: (totalConf/1000).toFixed(1) + " t"
        });

        // Export Certificates
        const cert = dataStore.certificates || [];
        const totalExport = cert.filter(r => (r.category_en === "Export CoH issued" || r.category_ar === "شهادات صحية تصدير"))
          .reduce((sum, row) => sum + (parseFloat(row.number_of_certificates_of_health) || 0), 0);
        metrics.push({
          title: translations[currentLang].metrics[4].title,
          value: totalExport.toLocaleString()
        });

        document.getElementById('metricsContainer').innerHTML = metrics.map(m =>
          `<div class="metric-card"><div class="metric-title">${m.title}</div><div class="metric-value">${m.value}</div></div>`
        ).join('');

        logDebug('Metrics rendered successfully', { metricsCount: metrics.length });
      } catch (error) {
        logDebug('Error rendering metrics', error);
      }
    }

    let chartInstances = [];
    function renderCharts() {
      logDebug('Rendering charts...');
      
      try {
        // Destroy existing charts
        chartInstances.forEach(ch => ch.destroy && ch.destroy());
        chartInstances = [];
        
        const chartsDiv = document.getElementById('chartsContainer');
        chartsDiv.innerHTML = '';

        // Helper function for robust year/category axis
        function allYearsFromDatasets(...datasets) {
          const years = new Set();
          datasets.forEach(ds => ds.forEach(row => {
            if (row.year !== undefined) years.add(String(parseInt(row.year)));
          }));
          return Array.from(years).sort();
        }

        // 1. Medical Certificates Chart
        const cert = dataStore.certificates || [];
        const yearsCert = allYearsFromDatasets(cert);
        const exportData = yearsCert.map(year =>
          cert.filter(row => String(parseInt(row.year)) === year && (row.category_en === "Export CoH issued" || row.category_ar === "شهادات صحية تصدير"))
            .reduce((sum, row) => sum + (parseFloat(row.number_of_certificates_of_health) || 0), 0)
        );
        const vetData = yearsCert.map(year =>
          cert.filter(row => String(parseInt(row.year)) === year && (row.category_en === "Veterinary CoH issued" || row.category_ar === "شهادات صحية بيطرية"))
            .reduce((sum, row) => sum + (parseFloat(row.number_of_certificates_of_health) || 0), 0)
        );
        
        chartsDiv.innerHTML += `<div class="chart-card"><h3>${translations[currentLang].charts[0]}</h3><div class="chart-container"><canvas id="certificatesChart"></canvas></div><div class="chart-narrative">${translations[currentLang].chartNarratives[0]}</div></div>`;
        chartInstances.push(new Chart(document.getElementById('certificatesChart').getContext('2d'), {
          type: 'line',
          data: {
            labels: yearsCert,
            datasets: [
              {label: currentLang === 'ar' ? 'تصدير' : 'Export', data: exportData, borderColor: '#007bff', fill:false, tension:0.3},
              {label: currentLang === 'ar' ? 'بيطرية' : 'Veterinary', data: vetData, borderColor: '#28a745', fill:false, tension:0.3}
            ]
          },
          options: {responsive:true, maintainAspectRatio: false, plugins: {legend: {position: 'top'}}, scales: {y: {beginAtZero:true}}}
        }));

        // 2. Food Laboratory Test Results Chart
        const foodLab = dataStore.foodLab || [];
        const yearsFood = allYearsFromDatasets(foodLab);
        const fitData = yearsFood.map(year =>
          foodLab.filter(row => String(parseInt(row.year)) === year && (row.analysis_results_en === "Fit" || row.analysis_results_ar === "صالحة"))
            .reduce((sum, row) => sum + (parseFloat(row.value) || 0), 0)
        );
        const unfitData = yearsFood.map(year =>
          foodLab.filter(row => String(parseInt(row.year)) === year && (row.analysis_results_en === "Unfit" || row.analysis_results_ar === "غير صالحة"))
            .reduce((sum, row) => sum + (parseFloat(row.value) || 0), 0)
        );
        
        chartsDiv.innerHTML += `<div class="chart-card"><h3>${translations[currentLang].charts[1]}</h3><div class="chart-container"><canvas id="foodLabChart"></canvas></div><div class="chart-narrative">${translations[currentLang].chartNarratives[1]}</div></div>`;
        chartInstances.push(new Chart(document.getElementById('foodLabChart').getContext('2d'), {
          type: 'bar',
          data: {
            labels: yearsFood,
            datasets: [
              {label: currentLang === 'ar' ? 'صالحة' : 'Fit', data: fitData, backgroundColor: '#28a745'},
              {label: currentLang === 'ar' ? 'غير صالحة' : 'Unfit', data: unfitData, backgroundColor: '#dc3545'}
            ]
          },
          options: {responsive:true, maintainAspectRatio: false, plugins: {legend: {position: 'top'}}, scales: {y: {beginAtZero:true}}}
        }));

        // 3. Confiscated Food & Health Products Chart
        const conf = dataStore.confiscated || [];
        const yearsConf = allYearsFromDatasets(conf);
        const confData = yearsConf.map(year =>
          conf.filter(row => String(parseInt(row.year)) === year)
            .reduce((sum, row) => sum + (parseFloat(row.confiscated_food_and_health_products_kg) || 0), 0)
        );
        
        chartsDiv.innerHTML += `<div class="chart-card"><h3>${translations[currentLang].charts[2]}</h3><div class="chart-container"><canvas id="confiscatedChart"></canvas></div><div class="chart-narrative">${translations[currentLang].chartNarratives[2]}</div></div>`;
        chartInstances.push(new Chart(document.getElementById('confiscatedChart').getContext('2d'), {
          type: 'line',
          data: {
            labels: yearsConf,
            datasets: [{
              label: currentLang === 'ar' ? 'المصادرات (كجم)' : 'Confiscated (kg)',
              data: confData,
              borderColor: '#ffc107',
              fill: true,
              backgroundColor: 'rgba(255, 193, 7, 0.3)',
              tension: 0.3
            }]
          },
          options: {responsive:true, maintainAspectRatio: false, plugins: {legend: {position: 'top'}}, scales: {y: {beginAtZero:true}}}
        }));

        // 4. Warnings & Violations by Category
        const violations = dataStore.violations || [];
        const yearsViol = allYearsFromDatasets(violations);
        const allCats = Array.from(new Set(violations.map(row => (currentLang === 'ar' ? row.category_ar : row.category_en)).filter(Boolean)));
        const violByCat = allCats.map(cat =>
          yearsViol.map(year =>
            violations.filter(row => String(parseInt(row.year)) === year && ((currentLang === 'ar' ? row.category_ar : row.category_en) === cat))
              .reduce((sum, row) => sum + (parseFloat(row.number_of_violations_and_cleanliness_issued_by_waste_management_public_higiene_sec) || 0), 0)
          )
        );
        
        chartsDiv.innerHTML += `<div class="chart-card"><h3>${translations[currentLang].charts[3]}</h3><div class="chart-container"><canvas id="violationsChart"></canvas></div><div class="chart-narrative">${translations[currentLang].chartNarratives[3]}</div></div>`;
        chartInstances.push(new Chart(document.getElementById('violationsChart').getContext('2d'), {
          type: 'bar',
          data: {
            labels: yearsViol,
            datasets: allCats.map((cat, i) => ({
              label: cat,
              data: violByCat[i],
              backgroundColor: ['#007bff','#28a745','#dc3545','#ffc107','#6f42c1','#00bcd4','#ff9800'][i % 7]
            }))
          },
          options: {responsive:true, maintainAspectRatio: false, plugins: {legend: {position: 'top'}}, scales: {y: {beginAtZero:true}}}
        }));

        // 5. Shops Visited Chart
        const shops = dataStore.shops || [];
        const yearsShops = allYearsFromDatasets(shops);
        const shopsData = yearsShops.map(year =>
          shops.filter(row => String(parseInt(row.year)) === year)
            .reduce((sum, row) => sum + (parseFloat(row.number_of_shops_visited) || 0), 0)
        );
        
        chartsDiv.innerHTML += `<div class="chart-card"><h3>${translations[currentLang].charts[4]}</h3><div class="chart-container"><canvas id="shopsChart"></canvas></div><div class="chart-narrative">${translations[currentLang].chartNarratives[4]}</div></div>`;
        chartInstances.push(new Chart(document.getElementById('shopsChart').getContext('2d'), {
          type: 'line',
          data: {
            labels: yearsShops,
            datasets: [{
              label: currentLang === 'ar' ? 'عدد المحلات' : 'Shops Visited',
              data: shopsData,
              borderColor: '#17a2b8',
              fill: false,
              tension: 0.3
            }]
          },
          options: {responsive:true, maintainAspectRatio: false, plugins: {legend: {position: 'top'}}, scales: {y: {beginAtZero:true}}}
        }));

        logDebug('Charts rendered successfully', { chartsCount: chartInstances.length });
      } catch (error) {
        logDebug('Error rendering charts', error);
      }
    }

    function renderInsights() {
      logDebug('Rendering insights...');
      try {
        const insights = translations[currentLang].insights;
        document.getElementById('insightsList').innerHTML = insights.map(ins =>
          `<div class="insight-item"><div class="insight-icon">${ins.icon}</div><div class="insight-text"><h4>${ins.title}</h4><p>${ins.text}</p></div></div>`
        ).join('');
        logDebug('Insights rendered successfully');
      } catch (error) {
        logDebug('Error rendering insights', error);
      }
    }

    // Initialize the dashboard when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      logDebug('Page loaded, initializing dashboard...');
      loadDataWithFallback();
    });
  </script>
</body>
</html>